<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>puppy俱乐部 - 专业游戏陪玩服务</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... 保持原有样式不变 ... */
        
        /* 新增：可滑动微信支付弹窗样式 */
        .modal-overlay.wechat-modal {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .wechat-modal-content {
            background: rgba(20, 20, 35, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 107, 107, 0.3);
            overflow: hidden;
            animation: modalAppear 0.4s ease-out;
        }
        
        @keyframes modalAppear {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .wechat-modal-header {
            padding: 22px 25px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            flex-shrink: 0;
        }
        
        .wechat-modal-title {
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            font-weight: 700;
            color: #ff6b6b;
        }
        
        .wechat-modal-title i {
            margin-right: 12px;
            font-size: 1.5rem;
        }
        
        .wechat-modal-close {
            position: absolute;
            top: 22px;
            right: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #a0a0c0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .wechat-modal-close:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .wechat-modal-body {
            padding: 0 25px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: #4ecdc4 rgba(255, 255, 255, 0.05);
        }
        
        .wechat-modal-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .wechat-modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .wechat-modal-body::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 10px;
        }
        
        .wechat-modal-body::-webkit-scrollbar-thumb:hover {
            background: #3db8b0;
        }
        
        .qr-code-container {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .qr-code-image {
            width: 220px;
            height: 220px;
            border-radius: 12px;
            border: 2px solid #4ecdc4;
            padding: 8px;
            background: white;
            margin: 0 auto 15px;
            display: block;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .qr-code-image:hover {
            transform: scale(1.03);
        }
        
        .qr-code-tip {
            font-size: 0.9rem;
            color: #a0a0c0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .order-summary-modal {
            background: rgba(78, 205, 196, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }
        
        .order-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .amount-label {
            color: #e0e0ff;
            font-size: 1.1rem;
        }
        
        .amount-value {
            font-weight: 700;
            color: #4ecdc4;
            font-size: 1.6rem;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        
        .order-services {
            margin-bottom: 15px;
        }
        
        .services-label {
            color: #e0e0ff;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .services-list {
            color: #f0f0f0;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .order-reminder {
            font-size: 0.85rem;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 15px;
        }
        
        .order-reminder i {
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .wechat-modal-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0 30px;
            flex-shrink: 0;
        }
        
        .wechat-modal-btn {
            flex: 1;
            padding: 16px 20px;
            border-radius: 12px;
            border: none;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .wechat-modal-btn.primary {
            background: linear-gradient(135deg, #4ecdc4, #3db8b0);
            color: white;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }
        
        .wechat-modal-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }
        
        .wechat-modal-btn.secondary {
            background: rgba(255, 255, 255, 0.08);
            color: #f0f0f0;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .wechat-modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .contact-info-modal {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #8888aa;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .contact-item-modal {
            margin-bottom: 8px;
        }
        
        .contact-item-modal i {
            color: #4ecdc4;
            margin-right: 8px;
        }
        
        /* 触摸滑动优化 */
        @media (max-width: 768px) {
            .wechat-modal-content {
                max-height: 90vh;
                border-radius: 16px;
            }
            
            .wechat-modal-header {
                padding: 20px 20px 15px;
            }
            
            .wechat-modal-body {
                padding: 0 20px;
            }
            
            .wechat-modal-close {
                top: 20px;
                right: 20px;
            }
            
            .qr-code-image {
                width: 200px;
                height: 200px;
            }
            
            .wechat-modal-actions {
                flex-direction: column;
                margin: 15px 0 25px;
            }
            
            .wechat-modal-btn {
                width: 100%;
                padding: 18px 20px;
            }
        }
        
        /* 保存到相册的样式 */
        .save-to-album-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .save-to-album-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }
        
        /* 新增：下拉刷新效果 */
        .pull-to-refresh {
            position: relative;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0a0c0;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .pull-to-refresh.show {
            opacity: 1;
        }
        
        .pull-to-refresh i {
            margin-right: 8px;
            transition: transform 0.3s;
        }
        
        .pull-to-refresh.pulling i {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <!-- 粒子背景容器 -->
    <div id="particles-js"></div>
    
    <!-- 主要内容区域 -->
    <div class="container">
        <!-- ... 保持原有内容不变 ... -->
    </div>

    <!-- iOS风格菜单容器 -->
    <div class="ios-menu-overlay" id="iosMenuOverlay">
        <!-- ... 保持原有内容不变 ... -->
    </div>

    <!-- 微信支付弹窗（新增可滑动版本） -->
    <div class="modal-overlay wechat-modal" id="wechatModalOverlay">
        <div class="wechat-modal-content">
            <div class="wechat-modal-header">
                <h2 class="wechat-modal-title"><i class="fab fa-weixin"></i> 微信扫码支付</h2>
                <button class="wechat-modal-close" id="wechatModalClose">&times;</button>
            </div>
            
            <div class="wechat-modal-body" id="wechatModalBody">
                <div class="pull-to-refresh" id="pullToRefresh">
                    <i class="fas fa-arrow-down"></i> 下拉关闭弹窗
                </div>
                
                <div class="qr-code-container">
                    <!-- 重要：请将下方src的图片路径替换为你自己的微信收款二维码 -->
                    <img id="wechatQrImage" class="qr-code-image" src="微信收款码.png.jpg" 
                         alt="微信收款二维码">
                    <div class="qr-code-tip">
                        <i class="fas fa-lightbulb"></i> 请截图保存二维码，然后打开微信扫一扫
                    </div>
                </div>
                
                <div class="order-summary-modal">
                    <div class="order-amount">
                        <span class="amount-label">订单金额：</span>
                        <span class="amount-value" id="modalAmount">0.00 元</span>
                    </div>
                    
                    <div class="order-services">
                        <div class="services-label">服务项目：</div>
                        <div class="services-list" id="modalServices">
                            请先选择服务项目
                        </div>
                    </div>
                    
                    <div class="order-reminder">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>付款时请截图此页面和付款截图，付款后联系客服微信确认订单</div>
                    </div>
                </div>
                
                <div class="wechat-modal-actions">
                    <button class="wechat-modal-btn primary save-to-album-btn" id="saveToAlbumBtn">
                        <i class="fas fa-camera"></i> 保存到相册
                    </button>
                    <button class="wechat-modal-btn secondary" id="closeWechatModalBtn">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                </div>
                
                <div class="contact-info-modal">
                    <div class="contact-item-modal">
                        <i class="fas fa-phone-alt"></i> 付款后请截图联系客服微信：Missuxn0917
                    </div>
                    <div class="contact-item-modal">
                        <i class="fas fa-clock"></i> 客服在线时间：10:00 - 次日 02:00
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知消息 -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <i class="fas fa-check-circle notification-icon"></i>
            <div class="notification-text" id="notificationText">服务已添加到订单</div>
        </div>
    </div>

    <!-- 引入粒子效果库 -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // 初始化粒子效果（保持原有代码不变）
        particlesJS('particles-js', {
            // ... 保持原有配置不变 ...
        });
        
        // 购物车数据（保持原有代码不变）
        let cart = [];
        let currentService = null;
        
        // 微信支付弹窗相关变量
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isDragging = false;
        let pullToRefreshElement = null;
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 从本地存储加载购物车（保持原有代码不变）
            loadCartFromStorage();
            
            // 添加卡片悬停效果（保持原有代码不变）
            const cards = document.querySelectorAll('.service-card');
            
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#feca57'];
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    this.style.borderColor = randomColor + '60';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.borderColor = 'rgba(100, 100, 150, 0.2)';
                });
            });
            
            // 为每个小分类添加点击事件（保持原有代码不变）
            const serviceItems = document.querySelectorAll('.service-item');
            
            serviceItems.forEach(item => {
                item.addEventListener('click', function() {
                    const serviceName = this.getAttribute('data-name');
                    const servicePrice = parseFloat(this.getAttribute('data-price'));
                    const serviceDescription = this.getAttribute('data-description');
                    
                    // 显示iOS风格菜单
                    showIosMenu(serviceName, servicePrice, serviceDescription);
                });
            });
            
            // 微信付款按钮点击事件 - 显示可滑动弹窗
            document.getElementById('wechatPayment').addEventListener('click', function() {
                showWechatModal();
            });
            
            // 支付宝付款按钮点击事件（保持原有代码不变）
            document.getElementById('alipayPayment').addEventListener('click', function(e) {
                const totalAmount = getTotalAmount();
                
                if (totalAmount <= 0) {
                    e.preventDefault();
                    showNotification('请先选择服务，订单总金额不能为0');
                    return false;
                }
                
                // 动态生成支付宝链接
                this.href = generateAlipayLink(totalAmount);
            });
            
            // iOS菜单按钮事件（保持原有代码不变）
            document.getElementById('iosMenuAddBtn').addEventListener('click', function() {
                if (currentService) {
                    addToCart(currentService.name, currentService.price, currentService.description);
                    hideIosMenu();
                }
            });
            
            document.getElementById('iosMenuCancelBtn').addEventListener('click', function() {
                hideIosMenu();
            });
            
            document.getElementById('iosMenuClose').addEventListener('click', function() {
                hideIosMenu();
            });
            
            // 点击遮罩层关闭菜单（保持原有代码不变）
            document.getElementById('iosMenuOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideIosMenu();
                }
            });
            
            // 微信弹窗关闭按钮事件
            document.getElementById('wechatModalClose').addEventListener('click', function() {
                hideWechatModal();
            });
            
            document.getElementById('closeWechatModalBtn').addEventListener('click', function() {
                hideWechatModal();
            });
            
            // 点击遮罩层关闭微信弹窗
            document.getElementById('wechatModalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideWechatModal();
                }
            });
            
            // 保存到相册按钮事件
            document.getElementById('saveToAlbumBtn').addEventListener('click', function() {
                saveQrCodeToAlbum();
            });
            
            // 初始化微信弹窗触摸事件
            initWechatModalTouchEvents();
            
            // 监听键盘ESC键关闭微信弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideWechatModal();
                }
            });
        });
        
        // 显示iOS风格菜单（保持原有代码不变）
        function showIosMenu(name, price, description) {
            // ... 保持原有代码不变 ...
        }
        
        // 隐藏iOS风格菜单（保持原有代码不变）
        function hideIosMenu() {
            // ... 保持原有代码不变 ...
        }
        
        // 计算总金额（保持原有代码不变）
        function getTotalAmount() {
            // ... 保持原有代码不变 ...
        }
        
        // 生成支付宝链接（保持原有代码不变）
        function generateAlipayLink(amount) {
            // ... 保持原有代码不变 ...
        }
        
        // 显示微信支付弹窗（新的可滑动版本）
        function showWechatModal() {
            const totalAmount = getTotalAmount();
            
            if (totalAmount <= 0) {
                showNotification('请先选择服务，订单总金额不能为0');
                return;
            }
            
            // 生成服务描述
            let serviceNames = [];
            cart.forEach(item => {
                serviceNames.push(item.name + ' × ' + item.quantity);
            });
            const serviceDesc = serviceNames.join('<br>');
            
            // 更新弹窗内容
            document.getElementById('modalAmount').textContent = totalAmount.toFixed(2) + ' 元';
            document.getElementById('modalServices').innerHTML = serviceDesc;
            
            // 显示弹窗
            const modal = document.getElementById('wechatModalOverlay');
            modal.style.display = 'flex';
            
            // 重置弹窗位置和状态
            const modalContent = document.querySelector('.wechat-modal-content');
            modalContent.style.transform = 'translateY(0)';
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏微信支付弹窗
        function hideWechatModal() {
            const modal = document.getElementById('wechatModalOverlay');
            modal.style.display = 'none';
            
            // 恢复背景滚动
            document.body.style.overflow = 'auto';
        }
        
        // 初始化微信弹窗触摸事件
        function initWechatModalTouchEvents() {
            const modalBody = document.getElementById('wechatModalBody');
            pullToRefreshElement = document.getElementById('pullToRefresh');
            
            modalBody.addEventListener('touchstart', function(e) {
                // 如果内容已经滚动到顶部，才允许下拉关闭
                if (modalBody.scrollTop === 0) {
                    touchStartY = e.touches[0].clientY;
                    isDragging = true;
                    pullToRefreshElement.classList.add('show');
                }
            }, { passive: true });
            
            modalBody.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                
                touchCurrentY = e.touches[0].clientY;
                const deltaY = touchCurrentY - touchStartY;
                
                // 只允许下拉，不允许上拉关闭
                if (deltaY > 0) {
                    e.preventDefault();
                    
                    // 限制最大下拉距离
                    const maxPull = 120;
                    const pullAmount = Math.min(deltaY, maxPull);
                    
                    // 移动弹窗
                    const modalContent = document.querySelector('.wechat-modal-content');
                    modalContent.style.transform = `translateY(${pullAmount}px)`;
                    
                    // 更新下拉提示
                    if (pullAmount > 60) {
                        pullToRefreshElement.classList.add('pulling');
                        pullToRefreshElement.innerHTML = '<i class="fas fa-arrow-down"></i> 释放关闭弹窗';
                    } else {
                        pullToRefreshElement.classList.remove('pulling');
                        pullToRefreshElement.innerHTML = '<i class="fas fa-arrow-down"></i> 下拉关闭弹窗';
                    }
                }
            }, { passive: false });
            
            modalBody.addEventListener('touchend', function() {
                if (!isDragging) return;
                
                isDragging = false;
                const modalContent = document.querySelector('.wechat-modal-content');
                const deltaY = touchCurrentY - touchStartY;
                
                // 如果下拉足够远，则关闭弹窗
                if (deltaY > 60) {
                    modalContent.style.transition = 'transform 0.3s ease';
                    modalContent.style.transform = 'translateY(100vh)';
                    
                    setTimeout(() => {
                        hideWechatModal();
                        modalContent.style.transition = '';
                        modalContent.style.transform = 'translateY(0)';
                    }, 300);
                } else {
                    // 否则恢复原位
                    modalContent.style.transition = 'transform 0.3s ease';
                    modalContent.style.transform = 'translateY(0)';
                    
                    setTimeout(() => {
                        modalContent.style.transition = '';
                    }, 300);
                }
                
                // 隐藏下拉提示
                pullToRefreshElement.classList.remove('show', 'pulling');
            }, { passive: true });
        }
        
        // 保存二维码到相册
        function saveQrCodeToAlbum() {
            const qrImage = document.getElementById('wechatQrImage');
            const totalAmount = getTotalAmount();
            
            // 检查图片是否存在
            if (!qrImage || qrImage.src.includes('微信收款码.png.jpg')) {
                showNotification('请先上传您的微信收款二维码图片');
                return;
            }
            
            // 创建一个临时canvas来生成图片
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸
            canvas.width = 300;
            canvas.height = 400;
            
            // 绘制背景
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制标题
            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 18px "Segoe UI", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('puppy俱乐部 - 微信支付', canvas.width/2, 30);
            
            // 绘制二维码
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // 绘制二维码
                ctx.drawImage(img, 50, 50, 200, 200);
                
                // 绘制订单信息
                ctx.fillStyle = '#4ecdc4';
                ctx.font = 'bold 16px "Segoe UI", sans-serif';
                ctx.fillText('订单金额: ' + totalAmount.toFixed(2) + ' 元', canvas.width/2, 280);
                
                ctx.fillStyle = '#f0f0f0';
                ctx.font = '14px "Segoe UI", sans-serif';
                
                // 绘制服务列表
                let serviceText = '服务项目:';
                let yPos = 310;
                cart.forEach((item, index) => {
                    if (index < 3) { // 最多显示3个服务
                        const serviceLine = `${item.name} × ${item.quantity}`;
                        ctx.fillText(serviceLine, canvas.width/2, yPos);
                        yPos += 20;
                    }
                });
                
                if (cart.length > 3) {
                    ctx.fillText(`...等${cart.length}个服务`, canvas.width/2, yPos);
                }
                
                // 绘制提示信息
                ctx.fillStyle = '#a0a0c0';
                ctx.font = '12px "Segoe UI", sans-serif';
                ctx.fillText('付款后请联系客服微信: Missuxn0917', canvas.width/2, yPos + 30);
                ctx.fillText('puppy俱乐部 © 2023', canvas.width/2, yPos + 50);
                
                // 将canvas转换为图片并下载
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `puppy俱乐部_微信支付_${totalAmount.toFixed(2)}元.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('二维码已保存到相册，请打开微信扫一扫');
            };
            
            img.onerror = function() {
                // 如果图片加载失败，使用备选方案
                const link = document.createElement('a');
                link.href = qrImage.src;
                link.download = `puppy俱乐部_微信收款码.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('二维码已保存，请打开微信扫一扫');
            };
            
            img.src = qrImage.src;
        }
        
        // 添加到购物车（保持原有代码不变）
        function addToCart(name, price, description) {
            // ... 保持原有代码不变 ...
        }
        
        // 从购物车移除项目（保持原有代码不变）
        function removeFromCart(index) {
            // ... 保持原有代码不变 ...
        }
        
        // 更新购物车数量（保持原有代码不变）
        function updateCartItemQuantity(index, change) {
            // ... 保持原有代码不变 ...
        }
        
        // 更新购物车显示（保持原有代码不变）
        function updateCartDisplay() {
            // ... 保持原有代码不变 ...
        }
        
        // 更新支付宝链接（保持原有代码不变）
        function updateAlipayLink(amount) {
            // ... 保持原有代码不变 ...
        }
        
        // 更新服务项的选中状态（保持原有代码不变）
        function updateServiceSelection() {
            // ... 保持原有代码不变 ...
        }
        
        // 显示通知（保持原有代码不变）
        function showNotification(message) {
            // ... 保持原有代码不变 ...
        }
        
        // 保存购物车到本地存储（保持原有代码不变）
        function saveCartToStorage() {
            // ... 保持原有代码不变 ...
        }
        
        // 从本地存储加载购物车（保持原有代码不变）
        function loadCartFromStorage() {
            // ... 保持原有代码不变 ...
        }
        
        // 全局函数（保持原有代码不变）
        window.closeModal = closeModal;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.updateCartItemQuantity = updateCartItemQuantity;
        window.saveQrImage = saveQrCodeToAlbum; // 更新全局函数名
    </script>
</body>
</html>